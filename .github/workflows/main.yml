name: Update PR with Preview URL

on:
  pull_request:
    types: [labeled, unlabeled, opened, synchronize, reopened]

jobs:
  update-pr-description:
    runs-on: ubuntu-latest
    steps:
      - name: Update PR Description with Preview URL
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const branchName = pr.head.ref;
            const hasPreviewLabel = pr.labels.some(label => label.name === 'preview');
            
            // Format branch name exactly as in ArgoCD
            const shortBranchName = branchName.substring(0, 25)
              .replace(/_/g, "-")
              .replace(/\//g, "-")
              .replace(/\./g, "-")
              .replace(/-+$/, "")
              .toLowerCase();
            
            const previewUrl = `https://${shortBranchName}.loculus.org`;
            
            // Get current PR description
            const prDesc = pr.body || '';
            const previewSectionMarker = '<!-- PREVIEW_DEPLOYMENT -->';
            const previewEndMarker = '<!-- END_PREVIEW_DEPLOYMENT -->';
            
            let updatedDesc;
            let previewSection;
            
            if (hasPreviewLabel) {
              // Create decorated preview section for active preview
              previewSection = `${previewSectionMarker}
### üîÑ Preview Deployment

> This PR has a preview deployment available:

<table>
  <tr>
    <td><strong>üåê Preview URL:</strong></td>
    <td><a href="${previewUrl}">${previewUrl}</a></td>
  </tr>
  <tr>
    <td><strong>üåø Branch:</strong></td>
    <td><code>${branchName}</code></td>
  </tr>
  <tr>
    <td><strong>‚è±Ô∏è Last updated:</strong></td>
    <td>${new Date().toISOString().replace('T', ' ').substring(0, 19)} UTC</td>
  </tr>
</table>

<details>
  <summary>‚ÑπÔ∏è About preview environments</summary>
  <p>Preview environments are automatically deployed when a PR has the <code>preview</code> label.</p>
  <p>The environment updates each time new commits are pushed to this branch.</p>
</details>
${previewEndMarker}`;
            } else {
              // Create decorated preview section for inactive preview
              previewSection = `${previewSectionMarker}
### ‚ö†Ô∏è Preview Deployment (Inactive)

> To enable a preview deployment, add the \`preview\` label to this PR.

${previewEndMarker}`;
            }
            
            if (prDesc.includes(previewSectionMarker) && prDesc.includes(previewEndMarker)) {
              // Update existing preview section
              const previewRegex = new RegExp(
                `${previewSectionMarker}[\\s\\S]*?${previewEndMarker}`, 'g'
              );
              updatedDesc = prDesc.replace(previewRegex, previewSection);
            } else {
              // Add preview section at the end
              updatedDesc = prDesc ? `${prDesc}\n\n${previewSection}` : previewSection;
            }
            
            // Update PR description
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              body: updatedDesc
            });
